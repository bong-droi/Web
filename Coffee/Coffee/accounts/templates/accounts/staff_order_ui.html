<style>
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding:18px }
    .card{ background:#fff; border:1px solid #eee; border-radius:12px; padding:14px }
    .card h3{ margin:0 0 10px }
    .toolbar{ display:flex; gap:8px; margin-bottom:12px }
    .toolbar button{ padding:8px 12px; border-radius:8px; border:1px solid #ddd; background:#f8f8f8; cursor:pointer }
    .table{ width:100%; border-collapse: collapse }
    .table th,.table td{ border:1px solid #eee; padding:8px; text-align:left }
    .muted{ color:#777 }
    .actions{ display:flex; gap:8px }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px }
    .badge.cancel{ background:#ffecec; color:#b30000; border:1px solid #ffd1d1 }
    </style>
    
    <div class="grid">
      <div class="card">
        <h3>Đơn đặt hàng</h3>
        <div class="toolbar">
          <button type="button">Tạo đơn mới</button>
          <button type="button">Làm mới</button>
        </div>
        <table class="table" id="ordersTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Loại</th>
              <th>Địa chỉ/Bàn</th>
              <th>Trạng thái</th>
              <th>Tổng</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody id="ordersBody">
            <tr><td colspan="6" class="muted">Đang tải...</td></tr>
          </tbody>
        </table>
      </div>
    
      <div class="card">
        <h3>Nhận đơn</h3>
        <div class="muted" id="detailHint">Chọn một đơn ở bảng bên trái để nhận.</div>
        <div id="detailBox" style="display:none">
          <div id="detailMeta" class="muted" style="margin-bottom:8px"></div>
          <table class="table">
            <thead>
              <tr><th>Món</th><th>SL</th><th>Đơn giá</th><th>Thành tiền</th><th>Món đã xử lý</th></tr>
            </thead>
            <tbody id="detailItems"><tr><td colspan="5" class="muted">Chưa có món.</td></tr></tbody>
            <tfoot><tr><td colspan="4" style="text-align:right"><b>Tổng</b></td><td id="detailTotal">0</td></tr></tfoot>
          </table>
          <div style="margin-top:10px" class="actions">
            <button type="button" id="btnComplete">Hoàn thành</button>
          </div>
        </div>
      </div>
    </div>
    
    <script>
    function renderOrders(rows){
      var body = document.getElementById('ordersBody');
      if(!rows || rows.length===0){ body.innerHTML = '<tr><td colspan="6" class="muted">Chưa có dữ liệu</td></tr>'; return; }
      var html = '';
      rows.forEach(function(o){
        var addr = (o.order_type==='online') ? (o.delivery_address || '-') : (o.table_number || '-');
        var isDone = (o.status==='processed');
        var isCanceled = (o.status==='canceled');
        html += '<tr data-id="'+o.id+'">'+
          '<td>#'+o.id+'</td>'+
          '<td>'+ (o.order_type==='online'?'Online':'Offline') +'</td>'+
          '<td>'+addr+'</td>'+
          '<td class="status-cell">'+ (isCanceled?('<span class="badge cancel">Đã hủy</span>'): (isDone?'Đã xử lý':'Đang chờ')) +'</td>'+
          '<td>'+ o.total +'</td>'+
          '<td><a href="#" data-id="'+o.id+'" class="link-detail">'+(isCanceled?'Xem':(isDone?'Xem':'Nhận đơn'))+'</a></td>'+
        '</tr>';
      });
      body.innerHTML = html;
    }
    
    function loadOrders(){
      fetch('/orders/api/list/').then(function(r){ return r.json(); }).then(function(res){
        if(res && res.ok){ renderOrders(res.orders || []); }
        else { renderOrders([]); }
      }).catch(function(){ renderOrders([]); });
    }
    
    loadOrders();
    
    document.addEventListener('click', function(e){
      if(e.target && e.target.classList.contains('link-detail')){
        e.preventDefault();
        var id = e.target.getAttribute('data-id');
        fetch('/orders/api/'+id+'/').then(function(r){return r.json()}).then(function(res){
          if(!(res && res.ok)) return;
          var o = res.order;
          var isDone = (o.status==='processed');
          var isCanceled = (o.status==='canceled');
          document.getElementById('detailHint').style.display='none';
          document.getElementById('detailBox').style.display='block';
          var meta = 'Đơn #'+o.id+' - '+(o.order_type==='online'?'Online':'Offline')+' - ' + (o.order_type==='online' ? (o.delivery_address||'-') : (o.table_number||'-')) + ' - Trạng thái: ' + (isCanceled?'Đã hủy':(isDone?'Đã xử lý':'Đang xử lý')) + ' | Đặt lúc: ' + o.created_at + (isDone && o.completed_at ? (' | Hoàn thành: ' + o.completed_at) : '') + (isCanceled && o.canceled_at ? (' | Hủy lúc: ' + o.canceled_at) : '');
          document.getElementById('detailMeta').innerText = meta;
          var itemsHtml=''; var total=0;
          (o.items||[]).forEach(function(i, idx){ 
            total+=i.line; 
            var lastCell = (isDone || isCanceled) ? '✓' : '<input type="checkbox" class="done-item" data-index="'+idx+'">';
            itemsHtml += '<tr><td>'+i.name+'</td><td>'+i.qty+'</td><td>'+i.price+'</td><td>'+i.line+'</td><td style="text-align:center">'+ lastCell +'</td></tr>'; 
          });
          document.getElementById('detailItems').innerHTML = itemsHtml || '<tr><td colspan="5" class="muted">Chưa có món.</td></tr>';
          document.getElementById('detailTotal').innerText = total;
          if(!isDone && !isCanceled){
            var row = document.querySelector('tr[data-id="'+o.id+'"] .status-cell');
            if(row){ row.textContent = 'Đang xử lý'; }
          }
          var csrfToken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
          var completeBtn = document.getElementById('btnComplete');
          completeBtn.style.display = (isDone || isCanceled) ? 'none' : 'inline-block';
          completeBtn.onclick = function(){
            var boxes = document.querySelectorAll('#detailItems .done-item');
            for(var k=0;k<boxes.length;k++){ if(!boxes[k].checked){ alert('Còn món chưa xử lý.'); return; } }
            fetch('/orders/api/'+id+'/complete/', {method:'POST', headers:{'X-CSRFToken': csrfToken}})
              .then(function(r){return r.json()}).then(function(x){ if(x && x.ok){ loadOrders(); document.getElementById('detailMeta').innerText = meta.replace('Đang xử lý','Đã xử lý'); var row2 = document.querySelector('tr[data-id="'+o.id+'"] .status-cell'); if(row2){ row2.textContent = 'Đã xử lý'; } completeBtn.style.display='none'; } });
          };
    
          // Hóa đơn: chỉ hiện khi đã xử lý
          var actions = document.querySelector('#detailBox .actions');
          if(isDone){
            var inv = document.getElementById('btnInvoice');
            if(!inv){
              inv = document.createElement('a');
              inv.id = 'btnInvoice';
              inv.className = 'btn';
              inv.style.marginLeft = '8px';
              inv.textContent = 'Xem hóa đơn';
              actions.appendChild(inv);
            }
            inv.href = '/orders/'+id+'/invoice/';
            inv.target = '_blank';
          } else {
            var inv2 = document.getElementById('btnInvoice');
            if(inv2){ inv2.remove(); }
          }
    
          // Lý do hủy: nếu bị hủy thì hiển thị
          var reasonEl = document.getElementById('cancelReason');
          if(!reasonEl){
            reasonEl = document.createElement('div');
            reasonEl.id = 'cancelReason';
            reasonEl.className = 'muted';
            reasonEl.style.marginTop = '8px';
            document.getElementById('detailBox').appendChild(reasonEl);
          }
          if(isCanceled){
            reasonEl.textContent = 'Lý do hủy: ' + (o.cancel_reason || '-');
            reasonEl.style.display = '';
          } else {
            reasonEl.style.display = 'none';
          }
        });
      }
    });
    </script>
    