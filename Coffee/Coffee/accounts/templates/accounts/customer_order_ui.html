{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>ƒê·∫∑t m√≥n | Kh√°ch h√†ng</title>
  <link rel="stylesheet" href="{% static 'accounts/css/dashboard.css' %}">
  <link rel="stylesheet" href="{% static 'menu/css/menu.css' %}">
  <style>
  .wrap{margin:0 clamp(12px, 4vw, 56px)}
  .grid{display:grid;grid-template-columns: 1.1fr .9fr;gap:18px}
  .card{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:18px;box-shadow:0 12px 40px rgba(0,0,0,.12)}
  .card h2{margin:0;padding:16px 18px;border-bottom:1px solid #f0eee9}
  .card .content{padding:16px 18px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
  .toolbar select,.toolbar input{padding:10px 12px;border:1px solid #e6e2dc;border-radius:12px}
  .toolbar .seg{display:flex;border:1px solid #e6e2dc;border-radius:12px;overflow:hidden}
  .toolbar .seg button{padding:10px 14px;border:0;background:#fff7ee;cursor:pointer}
  .toolbar .seg button.active{background: linear-gradient(180deg, #d3925d, #b96b33); color:#2a160f}
  .tabs{display:flex;gap:8px;margin:0}
  .tab{padding:8px 12px;border:1px solid #e6e2dc;border-radius:10px;background:#fff7ee;cursor:pointer}
  .tab.active{background: linear-gradient(180deg, #d3925d, #b96b33); color:#2a160f}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #f0eee9;padding:10px;text-align:left}
  .right{text-align:right}
  .muted{color:#777}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #d6d3d1;background:#111;color:#fff;cursor:pointer}
  .ghost{background:#fff7ee;color:#2a160f;border-color:#e6e2dc}
  .card .pic{width:100%;height:140px;border-radius:12px;overflow:hidden;background:#faf7f2;display:flex;align-items:center;justify-content:center}
  .card .pic img{width:100%;height:100%;object-fit:cover;display:block}
  .badge-tick{color:#1a7f37;margin-left:6px}
  /* Modal message */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);width:min(420px,92vw);padding:18px;border:1px solid rgba(0,0,0,.06)}
  .modal h3{margin:0 0 6px}
  .modal p{margin:0 0 14px;color:#444}
  .modal .row{display:flex;gap:10px;justify-content:flex-end}
  </style>
</head>
<body>
  <div class="bg"></div>

  <header class="dash-header">
    <div class="brand">
      <svg class="logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M4 12c0 4.418 3.582 8 8 8s8-3.582 8-8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        <path d="M7 10c0 3.314 2.686 6 6 6s6-2.686 6-6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <div class="brand-text">
        <h1>Xin ch√†o, {{ request.user.username }} üëã</h1>
        <p>H√£y ch·ªçn m√≥n b·∫°n y√™u th√≠ch h√¥m nay</p>
      </div>
    </div>
    <a class="logout-link" href="{% url 'logout' %}">ƒêƒÉng xu·∫•t</a>
  </header>

  <main class="dash-main">
    <div class="wrap" style="padding:18px 0">
      <div class="grid">
        <div class="card">
          <h2>Ch·ªçn m√≥n</h2>
          <div class="content">
            <div class="toolbar">
              <div class="seg" id="typeSeg">
                <button type="button" class="active" onclick="setType('offline', this)">Offline (t·∫°i b√†n)</button>
                <button type="button" onclick="setType('online', this)">Online (giao h√†ng)</button>
              </div>
              <select id="tableSelect">
                <option value="">Ch·ªçn s·ªë b√†n</option>
                <option>B√†n 1</option>
                <option>B√†n 2</option>
                <option>B√†n 3</option>
              </select>
              <input id="phoneInput" type="text" placeholder="S·ªë ƒëi·ªán tho·∫°i nh·∫≠n h√†ng (Online)" style="display:none" />
              <input id="addressInput" type="text" placeholder="ƒê·ªãa ch·ªâ giao h√†ng" style="display:none" />
            </div>

            <div class="grid" style="grid-template-columns: repeat(3, 1fr);gap:12px">
              {% for it in items %}
              <div class="card" style="border-radius:14px">
                <div class="content">
                  <div class="pic">
                    {% if it.image %}
                      <img src="{{ it.image.url }}" alt="{{ it.name }}">
                    {% else %}
                      <span class="muted">‚òï</span>
                    {% endif %}
                  </div>
                  <div class="title" style="margin-top:8px">{{ it.name }}</div>
                  <div class="muted">{% if it.category %}{{ it.category.name }}{% else %}Kh√¥ng ph√¢n lo·∫°i{% endif %}</div>
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                    <span>{{ it.price|floatformat:0 }}ƒë</span>
                    <button class="btn ghost add-btn" type="button" data-id="{{ it.id }}" data-name="{{ it.name|escapejs }}" data-price="{{ it.price|floatformat:0 }}">Th√™m</button>
                  </div>
                </div>
              </div>
              {% empty %}
              <div class="muted">Ch∆∞a c√≥ m√≥n n√†o.</div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="card">
          <div class="content">
            <div class="tabs">
              <button class="tab active" id="tabCart" onclick="showPanel('cart')">Gi·ªè h√†ng</button>
              <button class="tab" id="tabMy" onclick="showPanel('my')">ƒê∆°n h√†ng c·ªßa t√¥i</button>
            </div>
            <div id="panelCart">
            <table>
              <thead>
                <tr>
                  <th>M√≥n</th>
                  <th class="right">SL</th>
                  <th class="right">ƒê∆°n gi√°</th>
                  <th class="right">Th√†nh ti·ªÅn</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="cartBody">
                <tr><td colspan="5" class="muted">Ch∆∞a c√≥ m√≥n.</td></tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" class="right"><b>T·ªïng</b></td>
                  <td class="right" id="totalCell">0</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>

            <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
              <button class="btn ghost" type="button" onclick="clearCart()">X√≥a gi·ªè</button>
              <button id="placeBtn" class="btn" type="button" onclick="placeOrder()">ƒê·∫∑t h√†ng</button>
              <button class="btn ghost" type="button" onclick="cancelOrderPrompt()">H·ªßy ƒë∆°n</button>
            </div>
            </div>
            <div id="panelMy" style="display:none">
              <div id="myOrderBox" class="muted">Ch∆∞a c√≥ ƒë∆°n n√†o.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Centered message modal -->
  <div id="msgOverlay" class="modal-overlay">
    <div class="modal">
      <h3 id="msgTitle">Th√¥ng b√°o</h3>
      <p id="msgText">N·ªôi dung</p>
      <div class="row">
        <button class="btn" type="button" onclick="hideMsg()">OK</button>
      </div>
    </div>
  </div>

  <script>
  var orderType = 'offline';
  function setType(type, el){
    orderType = type;
    document.getElementById('addressInput').style.display = (type==='online')?'':'none';
    document.getElementById('tableSelect').style.display = (type==='offline')?'':'none';
    document.getElementById('phoneInput').style.display = (type==='online')?'':'none';
    document.querySelectorAll('#typeSeg button').forEach(function(b){ b.classList.remove('active'); });
    el.classList.add('active');
  }
  var cart = [];
  function addItem(name, price, id){
    var ex = cart.find(function(i){ return i.name===name; });
    if(ex){ ex.qty += 1; }
    else { cart.push({ id:id, name:name, price:price, qty:1 }); }
    renderCart();
  }
  function removeItem(name){
    cart = cart.filter(function(i){ return i.name!==name; });
    renderCart();
  }
  function changeQty(name, delta){
    var it = cart.find(function(i){ return i.name===name; });
    if(!it) return;
    it.qty = Math.max(1, it.qty + delta);
    renderCart();
  }
  function clearCart(){ cart = []; renderCart(); }
  function money(n){ return new Intl.NumberFormat('vi-VN').format(n) + 'ƒë'; }
  function renderCart(){
    var body = document.getElementById('cartBody');
    var btn = document.getElementById('placeBtn');
    if(cart.length===0){
      body.innerHTML = '<tr><td colspan="5" class="muted">Ch∆∞a c√≥ m√≥n.</td></tr>';
      document.getElementById('totalCell').innerText='0';
      if(btn){ btn.style.display = 'none'; }
      return;
    }
    var html = '';
    var total = 0;
    cart.forEach(function(i){
      var line = i.price * i.qty; total += line;
      html += '<tr>'+
        '<td>'+i.name+'</td>'+
        '<td class="right">'+
          '<button class="ghost" style="padding:2px 8px" onclick="changeQty(\''+i.name+'\', -1)">-</button> '+i.qty+' '+
          '<button class="ghost" style="padding:2px 8px" onclick="changeQty(\''+i.name+'\', 1)">+</button>'+
        '</td>'+
        '<td class="right">'+money(i.price)+'</td>'+
        '<td class="right">'+money(line)+'</td>'+
        '<td><button class="ghost" onclick="removeItem(\''+i.name+'\')">X√≥a</button></td>'+
      '</tr>';
    });
    body.innerHTML = html;
    document.getElementById('totalCell').innerText = money(total);
    if(btn){ btn.style.display = ''; }
  }
  function showMsg(title, text){
    document.getElementById('msgTitle').innerText = title || 'Th√¥ng b√°o';
    document.getElementById('msgText').innerText = text || '';
    document.getElementById('msgOverlay').style.display = 'flex';
  }
  function hideMsg(){ document.getElementById('msgOverlay').style.display = 'none'; }

  function placeOrder(){
    if(cart.length===0){ showMsg('Thi·∫øu th√¥ng tin', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√≥n.'); return; }
    // validate per type
    if(orderType==='offline'){
      var t = document.getElementById('tableSelect').value.trim();
      if(!t){ showMsg('Thi·∫øu s·ªë b√†n', 'Vui l√≤ng ch·ªçn s·ªë b√†n.'); return; }
    } else {
      var a = document.getElementById('addressInput').value.trim();
      var p = document.getElementById('phoneInput').value.trim();
      if(!a){ showMsg('Thi·∫øu ƒë·ªãa ch·ªâ', 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng.'); return; }
      if(!p){ showMsg('Thi·∫øu s·ªë ƒëi·ªán tho·∫°i', 'Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i nh·∫≠n h√†ng.'); return; }
    }
    // send to backend
    var csrfToken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
    var payload = {
      order_type: orderType,
      table_number: document.getElementById('tableSelect').value,
      phone_number: document.getElementById('phoneInput').value,
      delivery_address: document.getElementById('addressInput').value,
      items: cart.map(function(i){ return { menu_item_id: i.id, qty: i.qty }; })
    };
    fetch('{% url "create_order_from_customer" %}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
      body: JSON.stringify(payload)
    }).then(function(r){ return r.json(); }).then(function(res){
      if(res && res.ok){
        showMsg('Th√†nh c√¥ng', 'ƒê·∫∑t h√†ng th√†nh c√¥ng ‚úì');
        clearCart();
        window.latestOrderId = res.order_id;
        // Cho ph√©p ƒë·∫∑t ti·∫øp: n√∫t s·∫Ω ·∫©n/hi·ªán theo gi·ªè h√†ng qua renderCart()
      } else {
        showMsg('Kh√¥ng th·ªÉ ƒë·∫∑t h√†ng', (res && res.error ? res.error : 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
      }
    }).catch(function(e){ showMsg('L·ªói k·∫øt n·ªëi', String(e)); });
  }
  function cancelOrderPrompt(){
    if(!window.latestOrderId){ showMsg('Ch∆∞a c√≥ ƒë∆°n', 'B·∫°n ch∆∞a ƒë·∫∑t ƒë∆°n n√†o ƒë·ªÉ h·ªßy.'); return; }
    var reason = prompt('Nh·∫≠p l√Ω do h·ªßy ƒë∆°n:');
    if(reason===null){ return; }
    reason = String(reason||'').trim();
    if(!reason){ showMsg('Thi·∫øu l√Ω do', 'Vui l√≤ng nh·∫≠p l√Ω do h·ªßy.'); return; }
    var csrfToken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
    fetch('/orders/api/'+window.latestOrderId+'/cancel/', { method:'POST', headers:{ 'X-CSRFToken': csrfToken, 'Content-Type':'application/x-www-form-urlencoded' }, body: 'reason='+encodeURIComponent(reason) })
      .then(function(r){ return r.json(); }).then(function(res){
        if(res && res.ok){ showMsg('ƒê√£ h·ªßy', 'ƒê∆°n ƒë√£ ƒë∆∞·ª£c h·ªßy.'); }
        else { showMsg('Kh√¥ng th·ªÉ h·ªßy', (res && res.error ? res.error : 'L·ªói kh√¥ng x√°c ƒë·ªãnh')); }
      }).catch(function(e){ showMsg('L·ªói k·∫øt n·ªëi', String(e)); });
  }
  // Delegate add buttons
  document.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('add-btn')){
      var id = parseInt(e.target.getAttribute('data-id'));
      var name = e.target.getAttribute('data-name');
      var price = parseFloat(e.target.getAttribute('data-price'));
      addItem(name, price, id);
    }
  });

  function showPanel(which){
    var cartP = document.getElementById('panelCart');
    var myP = document.getElementById('panelMy');
    var tabCart = document.getElementById('tabCart');
    var tabMy = document.getElementById('tabMy');
    if(which==='my'){
      cartP.style.display='none';
      myP.style.display='block';
      tabCart.classList.remove('active');
      tabMy.classList.add('active');
      loadMyOrder();
    } else {
      cartP.style.display='block';
      myP.style.display='none';
      tabMy.classList.remove('active');
      tabCart.classList.add('active');
    }
  }

  function loadMyOrder(){
    fetch('/orders/api/my/').then(function(r){return r.json()}).then(function(res){
      var box = document.getElementById('myOrderBox');
      if(!(res && res.ok)){ box.innerText='Kh√¥ng t·∫£i ƒë∆∞·ª£c ƒë∆°n.'; return; }
      var orders = res.orders || [];
      if(orders.length===0){ box.innerText='Ch∆∞a c√≥ ƒë∆°n n√†o.'; return; }
      var html = '';
      orders.forEach(function(o){
        html += '<div style="border:1px solid #f0eee9;border-radius:12px;padding:10px;margin-bottom:10px;background:#fff">';
        html += '<div><b>ƒê∆°n #'+o.id+'</b> - '+(o.order_type==='online'?'Online':'Offline')+' - '+o.created_at+'</div>';
        html += '<div class="muted">'+ (o.order_type==='online' ? ('ƒê·ªãa ch·ªâ: '+(o.delivery_address||'-')+' | SƒêT: '+(o.phone_number||'-')) : ('B√†n: '+(o.table_number||'-'))) +'</div>';
        html += '<table style="width:100%;border-collapse:collapse;margin-top:8px">'+
                '<thead><tr><th>M√≥n</th><th class="right">SL</th><th class="right">ƒê∆°n gi√°</th><th class="right">Th√†nh ti·ªÅn</th></tr></thead><tbody>';
        var total=0;
        (o.items||[]).forEach(function(i){ total+=i.line; html += '<tr><td>'+i.name+'</td><td class="right">'+i.qty+'</td><td class="right">'+i.price+'</td><td class="right">'+i.line+'</td></tr>'; });
        html += '</tbody><tfoot><tr><td colspan="3" class="right"><b>T·ªïng</b></td><td class="right">'+total+'</td></tr></tfoot></table>';
        if(o.status!=='processed' && o.status!=='canceled'){
          html += '<div style="margin-top:10px;text-align:right"><button class="btn ghost" type="button" onclick="cancelOrderPromptFor('+o.id+')">H·ªßy ƒë∆°n</button></div>';
        }
        if(o.status==='canceled'){
          html += '<div class="muted" style="margin-top:6px">ƒê√£ h·ªßy: '+(o.cancel_reason||'-')+'</div>';
        }
        html += '</div>';
      });
      box.innerHTML = html;
    }).catch(function(){ document.getElementById('myOrderBox').innerText='Kh√¥ng t·∫£i ƒë∆∞·ª£c ƒë∆°n.'; });
  }

  function cancelOrderPromptFor(id){
    var reason = prompt('Nh·∫≠p l√Ω do h·ªßy ƒë∆°n:');
    if(reason===null){ return; }
    reason = String(reason||'').trim();
    if(!reason){ showMsg('Thi·∫øu l√Ω do', 'Vui l√≤ng nh·∫≠p l√Ω do h·ªßy.'); return; }
    var csrfToken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
    fetch('/orders/api/'+id+'/cancel/', { method:'POST', headers:{ 'X-CSRFToken': csrfToken, 'Content-Type':'application/x-www-form-urlencoded' }, body: 'reason='+encodeURIComponent(reason) })
      .then(function(r){ return r.json(); }).then(function(res){ if(res && res.ok){ loadMyOrder(); } else { showMsg('Kh√¥ng th·ªÉ h·ªßy', (res && res.error ? res.error : 'L·ªói kh√¥ng x√°c ƒë·ªãnh')); } });
  }
  </script>
  <footer class="dash-foot">¬© Coffee App</footer>
</body>
</html>


